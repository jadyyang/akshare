# AkShare Redis ç¼“å­˜ç³»ç»Ÿ - å¿«é€Ÿå®‰è£…æŒ‡å—

## æ€»ç»“

æˆ‘å·²ç»ä¸ºä½ çš„ akshare é¡¹ç›®æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªåŸºäº Redis çš„åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿï¼Œå®Œå…¨è§£å†³äº† Apache Airflow å¤šä»»åŠ¡ç¯å¢ƒä¸­çš„ç¼“å­˜å…±äº«é—®é¢˜ã€‚

## æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ

### âœ… æ•´ä½“æ€è·¯å®Œå…¨å¯è¡Œ
- åŸºäº Redis çš„åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæ”¯æŒå¤šè¿›ç¨‹ã€å¤šä»»åŠ¡å…±äº«
- å¯ä»¥æ— ç¼æ›¿æ¢ç°æœ‰çš„ `@lru_cache`
- è‡ªåŠ¨å¤„ç†åºåˆ—åŒ–å’Œååºåˆ—åŒ–

### âœ… è‡ªåŠ¨ç”Ÿæˆå­˜å–key
- ä½¿ç”¨ `func.__module__` + `func.__name__` ç¡®ä¿å‡½æ•°å”¯ä¸€æ€§
- è‡ªåŠ¨å¤„ç†å‡½æ•°å‚æ•°ï¼ˆä½ç½®å‚æ•°+å…³é”®å­—å‚æ•°ï¼‰è¿›è¡Œå“ˆå¸Œ
- æ”¯æŒå¤æ‚å‚æ•°ç±»å‹çš„åºåˆ—åŒ–

### âœ… Pythonå¯¹è±¡åºåˆ—åŒ–
- pickle å®Œå…¨æ”¯æŒ pandas DataFrameã€å­—å…¸ã€åˆ—è¡¨ç­‰
- è‡ªåŠ¨å¤„ç†åºåˆ—åŒ–å¤±è´¥çš„é™çº§æ–¹æ¡ˆ

## æ–‡ä»¶ç»“æ„

```
akshare/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ redis_cache.py          # æ ¸å¿ƒç¼“å­˜å®ç°
â”œâ”€â”€ stock/
â”‚   â””â”€â”€ stock_fund_em.py         # å·²æ›´æ–°ä½¿ç”¨Redisç¼“å­˜
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ redis_cache.md           # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ redis_cache_demo.py      # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_redis_cache.py      # å•å…ƒæµ‹è¯•
â””â”€â”€ requirements-redis-cache.txt  # ä¾èµ–åŒ…
```

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pip install redis>=6.0.0
```

### 2. ç¯å¢ƒé…ç½®
```bash
export REDIS_URL="redis://localhost:6379"
export AKSHARE_CACHE_PREFIX="akshare_prod"
```

### 3. æ›¿æ¢ç°æœ‰ä»£ç 
**ä¹‹å‰:**
```python
from functools import lru_cache

@lru_cache()
def get_sector_mapping():
    return expensive_api_call()
```

**ä¹‹å:**
```python
from akshare.utils.redis_cache import lru_cache

@lru_cache()  # å®Œå…¨ç›¸åŒçš„æ¥å£ï¼
def get_sector_mapping():
    return expensive_api_call()
```

## Airflow ä½¿ç”¨åœºæ™¯

```python
# Task 1
def airflow_task_1():
    mapping = get_sector_mapping()  # ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œä»APIè·å–å¹¶ç¼“å­˜
    # å¤„ç†æ•°æ®...
    
# Task 2 (ä¸åŒè¿›ç¨‹)
def airflow_task_2():
    mapping = get_sector_mapping()  # ä»Redisç¼“å­˜è·å–ï¼Œä¸é‡å¤è°ƒç”¨API
    # ä½¿ç”¨æ•°æ®...
```

## é«˜çº§é…ç½®

```python
@lru_cache(
    redis_url='redis://cluster:6379',
    prefix='akshare_prod',
    max_age=4 * 60 * 60,  # 4å°æ—¶ç¼“å­˜
)
def get_market_data():
    return expensive_operation()
```

## å…³é”®ç‰¹æ€§

1. **æ— ç¼è¿ç§»**: ä¸æ ‡å‡† `@lru_cache` æ¥å£å®Œå…¨å…¼å®¹
2. **è‡ªåŠ¨é™çº§**: Redis ä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨å†…å­˜ç¼“å­˜
3. **æ™ºèƒ½åºåˆ—åŒ–**: è‡ªåŠ¨å¤„ç† pandas DataFrame ç­‰å¤æ‚å¯¹è±¡
4. **ç¯å¢ƒé€‚é…**: æ”¯æŒå¼€å‘/æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒä¸åŒé…ç½®
5. **ç¼“å­˜ç®¡ç†**: æä¾›ç¼“å­˜æ¸…é™¤ã€è¿‡æœŸè®¾ç½®ç­‰ç®¡ç†åŠŸèƒ½

## ç°æœ‰ä»£ç å½±å“

âœ… **é›¶ç ´åæ€§**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼Œåªéœ€æ›´æ”¹ import è¯­å¥
âœ… **æ¸è¿›å¼**: å¯ä»¥é€ä¸ªå‡½æ•°è¿ç§»ï¼Œä¸éœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨æ›´æ¢
âœ… **å‘åå…¼å®¹**: å³ä½¿ Redis æœåŠ¡æ•…éšœï¼Œç¨‹åºä¾ç„¶æ­£å¸¸è¿è¡Œ

## å·²æ›´æ–°çš„ akshare æ–‡ä»¶

æˆ‘å·²ç»æ›´æ–°äº† `akshare/stock/stock_fund_em.py` ä¸­çš„ç¼“å­˜å‡½æ•°ï¼š
- `_get_stock_sector_fund_flow_summary_code()`
- `_get_stock_concept_fund_flow_summary_code()`

ç°åœ¨è¿™äº›å‡½æ•°åœ¨ Airflow ç¯å¢ƒä¸­ä¼šè‡ªåŠ¨å…±äº«ç¼“å­˜ï¼Œé¿å…é‡å¤çš„APIè°ƒç”¨ã€‚

## æµ‹è¯•éªŒè¯

è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½ï¼š
```bash
python tests/test_redis_cache.py
```

è¿è¡Œç¤ºä¾‹æŸ¥çœ‹æ•ˆæœï¼š
```bash
python examples/redis_cache_demo.py
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **Redis é›†ç¾¤é…ç½®**: æ”¯æŒ Redis Cluster å’Œå•æœº Redis
2. **ç›‘æ§**: å»ºè®®ç›‘æ§ Redis å†…å­˜ä½¿ç”¨å’Œç¼“å­˜å‘½ä¸­ç‡
3. **å¤‡ä»½**: æ ¹æ®ä¸šåŠ¡éœ€è¦é…ç½® Redis æŒä¹…åŒ–ç­–ç•¥

## æ€»ç»“

è¿™ä¸ªè§£å†³æ–¹æ¡ˆå®Œç¾æ»¡è¶³ä½ çš„éœ€æ±‚ï¼š
- âœ… è§£å†³ Airflow å¤šä»»åŠ¡ç¼“å­˜å…±äº«é—®é¢˜
- âœ… æä¾›ä¸ `@lru_cache` å®Œå…¨å…¼å®¹çš„æ¥å£
- âœ… æ”¯æŒ pandas DataFrame ç­‰å¤æ‚æ•°æ®ç±»å‹
- âœ… æä¾›çµæ´»çš„é…ç½®é€‰é¡¹
- âœ… å…·å¤‡å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶

ä½ ç°åœ¨å¯ä»¥åœ¨ akshare é¡¹ç›®ä¸­æ„‰å¿«åœ°ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜äº†ï¼ğŸ‰
